(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6380],{35626:(e,a,s)=>{"use strict";s.d(a,{A:()=>t});let t=(0,s(71847).A)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},40778:(e,a,s)=>{Promise.resolve().then(s.bind(s,84643))},84643:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>N});var t=s(95155),l=s(12115),i=s(35626),r=s(89715),n=s(16485),d=s(6132),c=s(39867),o=s(46046),h=s(65229),m=s(86948),x=s(3998),u=s(18332),v=s(86259),f=s(31120),j=s(75026),p=s(88112),y=s(77708),g=s(40357),w=s(20063);function N(e){let{params:a}=e,s=(0,w.useRouter)(),[N,b]=(0,l.useState)([]),[S,k]=(0,l.useState)([]),[T,A]=(0,l.useState)(new Set),[F,D]=(0,l.useState)(null),[C,P]=(0,l.useState)(""),[E,B]=(0,l.useState)(""),[I,O]=(0,l.useState)(!0),[V,Z]=(0,l.useState)(!1),[_,z]=(0,l.useState)(!1),[R,$]=(0,l.useState)(null);(0,l.useEffect)(()=>{!async function(){try{O(!0);let{id:e}=await a,s=await fetch("/api/delivery-notes/".concat(e)),t=await s.json();if(!t.success)return void $(t.error||"Failed to fetch delivery note");let l=t.data;D(l.owner),P(new Date(l.deliveryDate).toISOString().split("T")[0]),B(l.notes||""),A(new Set(l.vehicleIds));let[i,r]=await Promise.all([fetch("/api/vehicles?limit=1000"),fetch("/api/owners?limit=1000")]);if(i.ok){let e=await i.json();if(e.success&&e.data){let a=e.data.vehicles||e.data;b(a)}}if(r.ok){let e=await r.json();if(e.success&&e.data){let a=e.data.owners||e.data;k(a)}}}catch(e){console.error("Error fetching data:",e),$("Failed to load delivery note data")}finally{O(!1)}}()},[a]);let G=N.filter(e=>T.has(e.id)),U=async()=>{if(F&&0!==G.length){Z(!0);try{let{id:e}=await a,t=await fetch("/api/delivery-notes/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:F.id,deliveryDate:C,notes:E||null,vehicleIds:Array.from(T)})}),l=await t.json();if(l.success){let{id:e}=await a;s.push("/admin/delivery/".concat(e))}else alert("Failed to update delivery note: ".concat(l.error))}catch(e){console.error("Error updating delivery note:",e),alert("Failed to update delivery note. Please try again.")}finally{Z(!1)}}},W=async()=>{if(F&&0!==G.length){z(!0);try{let{id:e}=await a,t=await fetch("/api/delivery-notes/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({ownerId:F.id,deliveryDate:C,notes:E||null,vehicleIds:Array.from(T)})}),l=await t.json();if(l.success){let a={id:e,vehicles:G.map(e=>({id:e.id,vin:e.vin,make:e.make,model:e.model,year:e.year,color:e.color,status:e.status,trim:e.trim,engineType:e.engineType})),owner:F,deliveryDate:new Date(C),generatedAt:new Date,notes:E||void 0};(0,g.E)(a),s.push("/admin/delivery/".concat(e))}else alert("Failed to update delivery note: ".concat(l.error))}catch(e){console.error("Error generating and saving delivery note:",e),alert("Failed to generate and save delivery note. Please try again.")}finally{z(!1)}}},H=async()=>{let{id:e}=await a;s.push("/admin/delivery/".concat(e))},J=F&&G.length>0;return I?(0,t.jsx)("div",{className:"container mx-auto p-6",children:(0,t.jsx)("div",{className:"flex items-center justify-center min-h-[400px]",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Loading delivery note..."})]})})}):R?(0,t.jsx)("div",{className:"container mx-auto p-6",children:(0,t.jsx)(u.Fc,{children:(0,t.jsx)(u.TN,{children:R})})}):(0,t.jsxs)("div",{className:"container mx-auto p-6 space-y-6",children:[(0,t.jsx)("div",{className:"flex items-center justify-between",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)(x.$,{variant:"ghost",size:"sm",onClick:H,children:[(0,t.jsx)(i.A,{className:"h-4 w-4 mr-2"}),"Back to View"]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("h1",{className:"text-3xl font-bold tracking-tight flex items-center gap-3",children:[(0,t.jsx)(r.A,{className:"h-8 w-8 text-primary"}),"Edit Delivery Note"]}),(0,t.jsx)("p",{className:"text-muted-foreground mt-2",children:"Update delivery note details"})]})]})}),(0,t.jsx)(v.w,{}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch",style:{height:"calc(100vh - 250px)"},children:[(0,t.jsxs)("div",{className:"lg:col-span-1 flex flex-col gap-6",children:[(0,t.jsxs)(m.Zp,{className:"flex-[0.3] flex flex-col",children:[(0,t.jsxs)(m.aR,{children:[(0,t.jsx)(m.ZB,{children:"Selected Vehicles"}),(0,t.jsx)(m.BT,{children:"Vehicles to include in the delivery note"})]}),(0,t.jsx)(m.Wu,{className:"flex-1 overflow-hidden min-h-0",children:(0,t.jsx)(p.H,{vehicles:G,onRemove:e=>{let a=new Set(T);a.delete(e),A(a)}})})]}),(0,t.jsxs)(m.Zp,{className:"flex-[0.7] flex flex-col",children:[(0,t.jsxs)(m.aR,{children:[(0,t.jsx)(m.ZB,{children:"Delivery Information"}),(0,t.jsx)(m.BT,{children:"Select owner and delivery details"})]}),(0,t.jsxs)(m.Wu,{className:"flex-1 overflow-auto space-y-4",children:[(0,t.jsx)(y.B,{owners:S,selectedOwner:F,onSelectOwner:D}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("label",{className:"text-sm font-medium text-foreground flex items-center gap-2",children:[(0,t.jsx)(n.A,{className:"h-4 w-4"}),"Delivery Date"]}),(0,t.jsx)("input",{type:"date",value:C,onChange:e=>P(e.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"text-sm font-medium text-foreground",children:"Notes"}),(0,t.jsx)(f.T,{placeholder:"Add any additional notes for this delivery...",value:E,onChange:e=>B(e.target.value),className:"min-h-[100px]"})]}),(0,t.jsx)(v.w,{}),!J&&(0,t.jsxs)(u.Fc,{children:[(0,t.jsx)(d.A,{className:"h-4 w-4"}),(0,t.jsx)(u.TN,{children:F||0!==G.length?F?"Please select at least one vehicle":"Please select an owner":"Please select at least one vehicle and an owner"})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)(x.$,{onClick:W,disabled:!J||_,className:"w-full",size:"lg",children:_?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"animate-spin h-4 w-4 border-2 border-background border-t-transparent rounded-full mr-2"}),"Generating & Saving..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.A,{className:"h-4 w-4 mr-2"}),"Generate & Save"]})}),(0,t.jsx)(x.$,{onClick:U,disabled:!J||V,variant:"outline",className:"w-full",size:"lg",children:V?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"animate-spin h-4 w-4 border-2 border-primary border-t-transparent rounded-full mr-2"}),"Saving..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.A,{className:"h-4 w-4 mr-2"}),"Save"]})}),(0,t.jsxs)(x.$,{onClick:H,variant:"ghost",className:"w-full",size:"lg",children:[(0,t.jsx)(h.A,{className:"h-4 w-4 mr-2"}),"Cancel"]})]}),J&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"Generate & Save will update the note and download PDF"})]})]})]}),(0,t.jsx)("div",{className:"lg:col-span-2",children:(0,t.jsxs)(m.Zp,{className:"h-full",children:[(0,t.jsxs)(m.aR,{children:[(0,t.jsx)(m.ZB,{children:"Available Vehicles"}),(0,t.jsx)(m.BT,{children:"Search and select vehicles to add to the delivery note"})]}),(0,t.jsx)(m.Wu,{children:(0,t.jsx)(j.T,{vehicles:N,selectedVehicleIds:T,onToggleVehicle:e=>{let a=new Set(T);a.has(e)?a.delete(e):a.add(e),A(a)},onToggleAll:e=>{e?A(new Set(N.map(e=>e.id))):A(new Set)}})})]})})]})]})}}},e=>{e.O(0,[3930,5033,5239,3637,4127,2673,3437,861,9915,5108,8441,1255,7358],()=>e(e.s=40778)),_N_E=e.O()}]);